{% extends "viewer/base.html" %}
{% load static %}
{% load viewer_extras %}

{% block extra_head %}
<script type="text/javascript" src="{% static 'js/vendor/htmx.min.js' %}"></script>
<style>
    #preview-container {
        margin-top: 1rem;
        max-width: 300px;
    }

    #preview-image {
        width: 100%;
        display: none;
        border: 1px solid #ddd;
        padding: 5px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Image Search</h1>
        <hr>
        <div class="card mb-4">
            <div class="card-header">
                Search Parameters
            </div>
            <div class="card-body">
                <form id="image-search-form" hx-encoding='multipart/form-data' hx-post="{% url 'viewer:image-search' %}"
                    hx-target="#search-results" hx-indicator="#loading-indicator">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="image" class="form-label">Upload Image</label>
                        <input class="form-control" type="file" id="image" name="image" accept="image/*" required
                            onchange="previewImage(this)">
                        <div id="preview-container">
                            <img id="preview-image" src="#" alt="Image Preview">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Search</button>
                    <a href="{% url 'viewer:image-search' %}" class="btn btn-secondary">Reset</a>

                    <div class="mt-3">
                        <div class="progress" style="height: 25px; display: none;" id="progress-container">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0" aria-valuenow="0" aria-valuemin="0"
                                aria-valuemax="100">0%</div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="loading-indicator" class="text-center my-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Searching...</p>
        </div>

        <div id="search-results">
            <!-- Results will be loaded here -->
            {% if results %}
            {% include "viewer/include/image_search_results.html" %}
            {% elif request.method == "POST" and not error %}
            <div class="alert alert-warning">
                No matches found for the image.
            </div>
            {% endif %}

            {% if error %}
            <div class="alert alert-danger">
                Error: {{ error }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                var preview = document.getElementById('preview-image');
                preview.src = e.target.result;
                preview.style.display = 'block';
            }

            reader.readAsDataURL(input.files[0]);
        }
    }

    htmx.on('#image-search-form', 'htmx:xhr:progress', function (evt) {
        if (evt.detail.lengthComputable) {
            const next_value = evt.detail.loaded / evt.detail.total * 100;
            const progressBar = htmx.find('#progress-bar');
            const progressContainer = htmx.find('#progress-container');

            progressContainer.style.display = 'flex';
            progressBar.style.width = next_value + "%";
            progressBar.innerHTML = Math.round(next_value) + "%";
            progressBar.setAttribute('aria-valuenow', next_value);

            if (next_value >= 100) {
                progressBar.classList.remove('progress-bar-animated');
            } else {
                if (!progressBar.classList.contains('progress-bar-animated')) {
                    progressBar.classList.add('progress-bar-animated');
                }
            }
        }
    });

    htmx.on('#image-search-form', 'htmx:xhr:loadend', function (evt) {
        const progressBar = htmx.find('#progress-bar');
        const progressContainer = htmx.find('#progress-container');

        // Keep it at 100% or hide it? Typically reset or hide.
        // Let's reset it after a moment or just leave valid until new request.
        // For now, let's just leave it 100% or reset if needed.
        // Actually, user might want to see it completed.
        progressBar.classList.remove('progress-bar-animated');
    });
</script>
{% endblock %}